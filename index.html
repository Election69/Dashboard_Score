<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
     <title>Dashboard ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2569 ‡πÄ‡∏Ç‡∏ï 4 ‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700;800&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            overflow: hidden; margin: 0; padding: 0;
            display: flex; flex-direction: column; height: 100vh;
        }

        /* --- Header --- */
        .top-header {
            height: 70px; background: #2c3e50; color: white;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 9999; position: relative; flex-shrink: 0;
        }
        .brand-section { display: flex; align-items: center; }
        .brand-text { display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 1.3rem; }

        .right-controls { display: flex; align-items: center; gap: 15px; }
        
        .amphoe-group {
            display: flex; gap: 5px;
            background: rgba(255,255,255,0.1); padding: 4px; border-radius: 30px;
            overflow-x: auto; white-space: nowrap; scrollbar-width: none;
        }
        .amphoe-group::-webkit-scrollbar { display: none; }

        .btn-filter {
            background: transparent; border: none; color: rgba(255,255,255,0.8);
            padding: 6px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: bold;
            cursor: pointer; transition: all 0.2s; white-space: nowrap;
        }
        .btn-filter:hover { color: white; background: rgba(255,255,255,0.1); }
        .btn-filter.active { background: white; color: #2c3e50; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .divider { width: 1px; height: 25px; background: rgba(255,255,255,0.2); margin: 0 5px; flex-shrink: 0; }

        .tambon-wrapper {
            position: relative; background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 0 10px;
            display: flex; align-items: center; min-width: 140px;
        }
        .custom-select {
            background: transparent; border: none; color: white; font-weight: bold; font-size: 0.95rem;
            padding: 6px 25px 6px 10px; cursor: pointer; outline: none; appearance: none; width: 100%;
        }
        .custom-select option { color: #333; }
        .custom-select:disabled { color: rgba(255,255,255,0.4); cursor: not-allowed; }
        .dropdown-icon { position: absolute; right: 10px; font-size: 0.8em; opacity: 0.7; pointer-events: none; }

        .btn-toggle-sidebar {
            background: #f1c40f; color: #2c3e50; border: none;
            padding: 8px 20px; border-radius: 50px; font-weight: bold;
            transition: 0.2s; box-shadow: 0 4px 10px rgba(241, 196, 15, 0.3); white-space: nowrap;
        }

        /* --- Map --- */
        #map { flex-grow: 1; width: 100%; background: #f8f9fa; z-index: 1; }
        .map-legend {
            position: absolute; bottom: 30px; left: 30px; z-index: 1000;
            background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); font-size: 0.9em; border-left: 5px solid #2c3e50;
        }
        .color-dot { display: inline-block; width: 15px; height: 15px; border-radius: 3px; margin-right: 8px; vertical-align: middle; }

        /* Popup Styling */
        .custom-popup .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; }
        .custom-popup .leaflet-popup-content { margin: 0; width: 340px !important; }
        .popup-header { background: #2c3e50; color: white; padding: 15px 10px; text-align: center; }
        .popup-unit-container { background: #f8f9fa; padding: 10px; border-bottom: 1px solid #ddd; text-align: center; }
        .btn-overview-wrapper { margin-bottom: 8px; display: flex; justify-content: center; }
        .btn-unit-select.btn-overview { width: 100%; max-width: 250px; border-radius: 20px; background: #3f8a49; color: #d9e0e7; border-color: #91f1a9; }
        .btn-unit-select.btn-overview.active { background: #3f8a49; color: #fff; }
        
        .popup-unit-grid { display: flex; flex-wrap: nowrap; overflow-x: auto; gap: 8px; padding: 5px 2px 12px 2px; justify-content: flex-start; scrollbar-width: thin; scrollbar-color: #adb5bd #f1f3f5; }
        .popup-unit-grid::-webkit-scrollbar { height: 7px; }
        .popup-unit-grid::-webkit-scrollbar-track { background: #f1f3f5; border-radius: 4px; }
        .popup-unit-grid::-webkit-scrollbar-thumb { background: #adb5bd; border-radius: 4px; }
        .btn-unit-select { width: 35px; height: 35px; border: 1px solid #ced4da; background: white; color: #555; border-radius: 50%; font-size: 0.9rem; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; flex-shrink: 0; }
        .btn-unit-select:hover { background: #052b0b; border-color: #adb5bd; }
        .btn-unit-select.active { background: #2c3e50; color: white; border-color: #2c3e50; transform: scale(1.1); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .popup-body { padding: 15px; background: #fff; min-height: 250px; }
        .popup-row { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .popup-img { width: 40px; height: 40px; object-fit: contain; margin-right: 10px; }

        /* --- Sidebar --- */
        .offcanvas-end { 
            width: 420px; z-index: 9990; 
            top: 70px !important; bottom: 0 !important; height: auto !important; 
            border-left: 1px solid #ddd; box-shadow: -5px 0 15px rgba(0,0,0,0.1);
        }
        .offcanvas-body { display: flex; flex-direction: column; padding: 0; overflow: hidden; }
        .ranking-scroll-area { flex-grow: 1; overflow-y: auto; padding: 20px; }
        
        .stats-fixed-bottom { 
            flex-shrink: 0; background: #fff; 
            padding: 10px 15px 30px 15px; 
            border-top: 1px solid #eee; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); 
        }

        .rank-big { background: #fff; border-left: 5px solid #f1c40f; }
        .rank-img-big { width: 80px; height: auto; object-fit: contain; border: none; }
        .rank-img-small { width: 45px; height: auto; object-fit: contain; border-radius: 0; }

        /* --- CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î Layout Hybrid (Desktop vs Mobile) --- */
        
        /* 1. ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Desktop (‡∏à‡∏≠‡πÉ‡∏´‡∏ç‡πà): ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ (‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á) */
        .stat-card-body {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            text-align: left;
        }
        .stat-info-left { text-align: left; }
        .stat-info-right { width: 45%; text-align: right; }

        /* 2. ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Mobile (‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å): ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ö‡∏ô-‡∏•‡πà‡∏≤‡∏á (‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡πÉ‡∏ô col-6 ‡πÑ‡∏î‡πâ‡∏™‡∏ß‡∏¢ */
        @media (max-width: 768px) { 
            .top-header { height: auto; min-height: 80px; flex-direction: column; padding: 15px; gap: 15px; align-items: center; }
            .brand-section { width: 100%; justify-content: center; }
            .brand-icon { display: none; }
            .brand-text { flex-direction: column; align-items: center; gap: 2px; line-height: 1.2; }
            .right-controls { flex-direction: row; flex-wrap: wrap; justify-content: space-between; width: 100%; gap: 10px; }
            .amphoe-group { flex-basis: 100%; order: 1; justify-content: space-between; margin-bottom: 5px; }
            .btn-filter { flex-grow: 1; text-align: center; }
            .divider { display: none; }
            .tambon-wrapper { flex-grow: 1; order: 2; margin-right: 10px; }
            .btn-toggle-sidebar { order: 3; }
            
            /* Sidebar ‡∏¢‡∏∂‡∏î‡∏•‡πà‡∏≤‡∏á */
            .offcanvas-end { 
                width: 100%; top: 190px !important; bottom: 0 !important; 
                height: auto !important; border-left: none; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); 
            }
            .stats-fixed-bottom { padding-bottom: calc(20px + env(safe-area-inset-bottom)); }
            .offcanvas-backdrop { display: none !important; }
            .map-legend { display: none; }

            /* *** Override Layout ‡∏Å‡∏•‡πà‡∏≠‡∏á Stats *** */
            .stat-card-body {
                flex-direction: column; /* ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
                justify-content: center;
                text-align: center;
                padding: 10px 5px;
            }
            .stat-info-left { text-align: center; width: 100%; margin-bottom: 5px; }
            .stat-info-right { width: 100%; text-align: center; }
        }
    </style>
</head>
<body>

    <div class="top-header">
        <div class="brand-section">
            <i class="fas fa-vote-yea me-3 text-warning brand-icon" style="font-size: 1.5rem;"></i>
            <div class="brand-text">
                <span class="line-1">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á ‡∏™.‡∏™. 2569</span>
                <span class="line-2">‡πÄ‡∏Ç‡∏ï 4 ‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™ (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£)</span>
            </div>
        </div>

        <div class="right-controls">
            <div id="amphoeGroup" class="amphoe-group">
                </div>
            <div class="divider"></div>
            <div class="tambon-wrapper">
                <select id="selectTambon" class="custom-select" onchange="filterData()" disabled>
                    <option value="all">üö© ‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>
                </select>
                <i class="fas fa-chevron-down text-white dropdown-icon"></i>
            </div>
            <button class="btn-toggle-sidebar" type="button" data-bs-toggle="offcanvas" data-bs-target="#rightSidebar">
                <i class="fas fa-list-ol me-2"></i> ‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            </button>
        </div>
    </div>

    <div id="map"></div>

    <div class="map-legend">
        <div class="fw-bold mb-2">‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå</div>
        <div class="mb-1"><span class="color-dot" style="background:#e74c3c;"></span> ‡∏≠.‡∏£‡∏∞‡πÅ‡∏á‡∏∞</div>
        <div class="mb-1"><span class="color-dot" style="background:#f39c12;"></span> ‡∏≠.‡∏à‡∏∞‡πÅ‡∏ô‡∏∞</div>
        <div class="mb-1"><span class="color-dot" style="background:#3498db;"></span> ‡∏≠.‡∏™‡∏∏‡∏Ñ‡∏¥‡∏£‡∏¥‡∏ô</div>
    </div>

    <div class="offcanvas offcanvas-end show" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1" id="rightSidebar">
        <div class="offcanvas-header bg-light border-bottom">
            <h5 class="offcanvas-title text-dark fw-bold"><i class="fas fa-trophy text-warning me-2"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body bg-light">
            <div class="ranking-scroll-area">
                <div id="top3List"></div>
                <h6 class="fw-bold text-secondary small mb-3 mt-4">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</h6>
                <div id="next3List"></div>
            </div>
            
            <div class="stats-fixed-bottom">
                <div class="row g-2">
                    
                    <div class="col-6 col-md-12">
                        <div class="card border-0 shadow-sm rounded-4 bg-white h-100">
                            <div class="stat-card-body"> <div class="stat-info-left">
                                    <small class="text-uppercase text-muted fw-bold d-block" style="font-size:0.7em;">
                                        <i class="fas fa-users"></i> ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
                                    </small>
                                    <div class="fw-bold text-dark" id="totalTurnout" style="font-size:1.1rem;">... / ...</div>
                                </div>
                                <div class="stat-info-right">
                                    <small id="turnoutPercent" class="fw-bold text-success" style="font-size:0.9rem;">0%</small>
                                    <div class="progress rounded-pill bg-light mt-1" style="height: 6px;">
                                        <div class="progress-bar bg-success" id="turnoutBar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-6 col-md-12">
                        <div class="card border-0 shadow-sm rounded-4 bg-white h-100">
                            <div class="stat-card-body"> <div class="stat-info-left">
                                    <small class="text-uppercase text-muted fw-bold d-block" style="font-size:0.7em;">
                                        <i class="fas fa-chart-bar"></i> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
                                    </small>
                                    <div class="fw-bold text-primary" id="countingDisplay" style="font-size:1.1rem;">0%</div>
                                </div>
                                <div class="stat-info-right">
                                    <div class="progress rounded-pill bg-light mt-2" style="height: 8px;">
                                        <div class="progress-bar bg-primary progress-bar-striped progress-bar-animated" id="countingBar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxjGKqtdINH8KQIH4exj3qyE2zdsNNDj9Mm5x7kWyFI-UgJ9a2zsbFKXpzffOtpm1ea_Q/exec';
        
        const candidatesConfig = [
            { no: 1, party: "‡∏û‡∏£‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏≤‡∏ï‡∏¥", name: "‡∏ô‡∏≤‡∏¢‡∏Å‡∏π‡πÄ‡∏Æ‡∏á ‡∏¢‡∏≤‡∏ß‡∏≠‡∏´‡∏∞‡∏ã‡∏±‡∏ô", imgSidebar: "https://img2.pic.in.th/14746ae2e943b791f.png", imgPopup: "https://img2.pic.in.th/1350d68330953409d.png" },
            { no: 2, party: "‡∏û‡∏£‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ò‡∏¥‡∏õ‡∏±‡∏ï‡∏¢‡πå", name: "‡∏ô‡∏≤‡∏¢‡∏Å‡∏≠‡πÄ‡∏ã‡πá‡∏á ‡∏°‡∏∞‡πÄ‡∏ã‡πá‡∏á", imgSidebar: "https://img5.pic.in.th/file/secure-sv1/2f20164de60a3b0c8.png", imgPopup: "https://img5.pic.in.th/file/secure-sv1/2e202bb41458cf2b1.png" },
            { no: 3, party: "‡∏û‡∏£‡∏£‡∏Ñ‡∏Å‡∏•‡πâ‡∏≤‡∏ò‡∏£‡∏£‡∏°", name: "‡∏ô‡∏≤‡∏¢‡∏≠‡∏î‡∏¥‡∏®‡∏£ ‡∏≠‡∏≤‡πÅ‡∏ß‡πÄ‡∏ï‡πä‡∏∞", imgSidebar: "https://img2.pic.in.th/31703a588faa60731.jpg", imgPopup: "https://img2.pic.in.th/315d39fe9e514ce03.png" },
            { no: 4, party: "‡∏û‡∏£‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô", name: "‡∏ô‡∏≤‡∏¢‡∏≠‡∏±‡∏Å‡∏ö‡∏±‡∏£ ‡πÄ‡∏ã‡∏£‡∏≤‡∏•‡∏µ", imgSidebar: "https://img5.pic.in.th/file/secure-sv1/47d4ceea9d498867b.png", imgPopup: "https://img5.pic.in.th/file/secure-sv1/48e77349737a85eda.png" },
            { no: 5, party: "‡∏û‡∏£‡∏£‡∏Ñ‡∏†‡∏π‡∏°‡∏¥‡πÉ‡∏à‡πÑ‡∏ó‡∏¢", name: "‡∏ô‡∏≤‡∏¢‡∏ã‡∏≤‡∏Å‡∏≤‡∏£‡∏µ‡∏¢‡∏≤ ‡∏™‡∏∞‡∏≠‡∏¥", imgSidebar: "https://img2.pic.in.th/51fe81d8bbda133aa.png", imgPopup: "https://img2.pic.in.th/5b028fab05d845d6a.png" },
            { no: 6, party: "‡∏û‡∏£‡∏£‡∏Ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢", name: "‡∏ô‡∏≤‡∏¢‡∏°‡∏≤‡∏£‡πå‡∏ß‡∏≤‡∏ô ‡∏ö‡∏¥‡∏ô‡∏ö‡∏µ‡∏î‡∏µ", imgSidebar: "https://img2.pic.in.th/69adc3cca999bb66d.png", imgPopup: "https://img2.pic.in.th/69adc3cca999bb66d.png" }
        ];

        const map = L.map('map', { zoomControl: false }).setView([6.05, 101.80], 10);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        let geojsonLayer;
        let markersLayer = L.layerGroup().addTo(map);
        let globalData = null;
        let currentAmphoe = 'all';

        loadBoundaries();
        fetchData();

        async function loadBoundaries() {
            try {
                const geoUrl = 'https://raw.githubusercontent.com/jitlogo/thailand-geojson/master/amphoe.geojson';
                const response = await fetch(geoUrl);
                const geoData = await response.json();

                geojsonLayer = L.geoJSON(geoData, {
                    filter: function(feature) {
                        const props = JSON.stringify(feature.properties).toLowerCase();
                        return (props.includes('ra-ngae') || props.includes('‡∏£‡∏∞‡πÅ‡∏á‡∏∞')) ||
                               (props.includes('chanae') || props.includes('‡∏à‡∏∞‡πÅ‡∏ô‡∏∞')) ||
                               (props.includes('sukhirin') || props.includes('‡∏™‡∏∏‡∏Ñ‡∏¥‡∏£‡∏¥‡∏ô'));
                    },
                    style: function(feature) {
                        const props = JSON.stringify(feature.properties).toLowerCase();
                        let color = '#999';
                        if (props.includes('ra-ngae')) color = '#e74c3c';
                        else if (props.includes('chanae')) color = '#f39c12';
                        else if (props.includes('sukhirin')) color = '#3498db';
                        return { color: 'white', weight: 2, opacity: 1, fillColor: color, fillOpacity: 0.2 };
                    },
                    onEachFeature: function(feature, layer) {
                        layer.bindTooltip(feature.properties.NAME_TH || feature.properties.NAME_2, {
                            permanent: true, direction: 'center', className: 'bg-transparent border-0 fw-bold text-dark shadow-none'
                        });
                        layer.on('click', function(e) { map.fitBounds(e.target.getBounds()); });
                    }
                }).addTo(map);
                if (geojsonLayer.getLayers().length > 0) map.fitBounds(geojsonLayer.getBounds());
            } catch (err) { console.error(err); }
        }

        async function fetchData() {
            try {
                const response = await fetch(scriptURL);
                globalData = await response.json();
                initFilterButtons(globalData.units);
                filterData();
            } catch (error) { console.error("Fetch Error:", error); }
        }

        function initFilterButtons(units) {
            const amphoeSet = new Set();
            units.forEach(u => { if(u[5]) amphoeSet.add(u[5]); });

            const btnContainer = document.getElementById('amphoeGroup');
            
            let allBtn = document.createElement('button');
            allBtn.className = 'btn-filter active';
            allBtn.innerText = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
            allBtn.onclick = () => selectAmphoe('all', allBtn);
            btnContainer.appendChild(allBtn);

            amphoeSet.forEach(amp => {
                let btn = document.createElement('button');
                btn.className = 'btn-filter';
                btn.innerText = amp;
                btn.onclick = () => selectAmphoe(amp, btn);
                btnContainer.appendChild(btn);
            });
        }

        function selectAmphoe(amphoe, btnElement) {
            currentAmphoe = amphoe;
            document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');

            const selectTambon = document.getElementById('selectTambon');
            selectTambon.innerHTML = '<option value="all">üö© ‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>';
            selectTambon.value = 'all';

            if (currentAmphoe === 'all') {
                selectTambon.disabled = true;
                if (geojsonLayer) map.fitBounds(geojsonLayer.getBounds());
            } else {
                selectTambon.disabled = false;
                const tambonSet = new Set();
                globalData.units.forEach(u => {
                    if (u[5] === currentAmphoe && u[6]) tambonSet.add(u[6]);
                });
                tambonSet.forEach(tam => {
                    let opt = document.createElement('option');
                    opt.value = tam;
                    opt.text = tam;
                    selectTambon.appendChild(opt);
                });
                
                if (geojsonLayer) {
                    geojsonLayer.eachLayer(function(layer) {
                        const props = JSON.stringify(layer.feature.properties).toLowerCase();
                        let mapName = "";
                        if(currentAmphoe.includes("‡∏£‡∏∞‡πÅ‡∏á‡∏∞")) mapName = "ra-ngae";
                        else if(currentAmphoe.includes("‡∏à‡∏∞‡πÅ‡∏ô‡∏∞")) mapName = "chanae";
                        else if(currentAmphoe.includes("‡∏™‡∏∏‡∏Ñ‡∏¥‡∏£‡∏¥‡∏ô")) mapName = "sukhirin";
                        if(mapName && props.includes(mapName)) {
                            map.fitBounds(layer.getBounds());
                        }
                    });
                }
            }
            filterData();
        }

        function filterData() {
            if (!globalData) return;

            const selectedAmphoe = currentAmphoe;
            const selectTambon = document.getElementById('selectTambon');
            const selectedTambon = selectTambon.value;

            let filteredUnits = globalData.units.filter(u => {
                let matchAmphoe = (selectedAmphoe === 'all') || (u[5] === selectedAmphoe);
                let matchTambon = (selectedTambon === 'all') || (u[6] === selectedTambon);
                return matchAmphoe && matchTambon;
            });

            calculateAndRender(filteredUnits, globalData.scores);

            if (selectedTambon !== 'all') {
                if (filteredUnits.length > 0) {
                    let latlngs = [];
                    filteredUnits.forEach(u => {
                        let lat = parseFloat(u[2]);
                        let lng = parseFloat(u[3]);
                        if(!isNaN(lat) && !isNaN(lng)) latlngs.push([lat, lng]);
                    });
                    if (latlngs.length > 0) {
                        let bounds = L.latLngBounds(latlngs);
                        map.fitBounds(bounds, { padding: [50, 50], maxZoom: 14 });
                    }
                }
            }
        }

        // --- üü¢ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (Finish Logic) üü¢ ---
        function getUnitScores(unitName) {
            let currentScores = [0,0,0,0,0,0];
            let votedCount = 0;
            const unitScoresLog = globalData.scores.filter(row => row[1] === unitName);
            
            if (unitScoresLog.length > 0) {
                let targetRow = unitScoresLog[unitScoresLog.length - 1];
                
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Finish ‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≠‡∏ô‡πÑ‡∏õ‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                if (targetRow[4] === 'Finish') {
                    for (let i = unitScoresLog.length - 2; i >= 0; i--) {
                        if (unitScoresLog[i][4] !== 'Finish') {
                            targetRow = unitScoresLog[i]; 
                            break;
                        }
                    }
                }

                for(let i=0; i<6; i++) {
                    let sc = parseInt(targetRow[5+i]) || 0; 
                    currentScores[i] = sc;
                    votedCount += sc;
                }
            }
            return { scores: currentScores, voted: votedCount };
        }

        function calculateAndRender(units, scores) {
            markersLayer.clearLayers();

            let globalScores = [0,0,0,0,0,0];
            let totalEligible = 0;
            let totalVoted = 0;

            units.forEach(unit => {
                const unitName = unit[0];
                const lat = parseFloat(unit[2]);
                const lng = parseFloat(unit[3]);
                const unitVoters = parseInt(unit[4]) || 0;
                const amphoe = unit[5] || '-';
                const tambon = unit[6] || '-';

                totalEligible += unitVoters;

                const unitData = getUnitScores(unitName);
                
                for(let i=0; i<6; i++) globalScores[i] += unitData.scores[i];
                totalVoted += unitData.voted;

                if (!isNaN(lat) && !isNaN(lng)) {
                    createMarker(lat, lng, unitName, amphoe, tambon);
                }
            });

            // ----------------------------------------------------
            // üü¢ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Progress (Global Finish / Global Total)
            // ----------------------------------------------------
            let globalCompleted = 0;
            let globalTotalUnits = globalData.units.length;

            globalData.units.forEach(u => {
                const uName = u[0];
                const logs = scores.filter(row => row[1] === uName);
                const isFinished = logs.some(log => log[4] === 'Finish');
                if (isFinished) {
                    globalCompleted++;
                }
            });

            let progressPercent = 0;
            if (globalTotalUnits > 0) {
                progressPercent = (globalCompleted / globalTotalUnits) * 100;
            }
            // ----------------------------------------------------

            updateSidebar(globalScores, totalEligible, totalVoted, progressPercent);
        }

        window.switchPopupView = function(viewId, btn, id) {
            const container = document.getElementById(id);
            if(!container) return;
            container.querySelectorAll('.btn-unit-select').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            container.querySelectorAll('.view-content').forEach(v => v.style.display = 'none');
            document.getElementById(viewId).style.display = 'block';
        }

        function createMarker(lat, lng, unitName, amphoe, tambon) {
            const uniqueId = `popup-${Math.floor(Math.random()*1000000)}`;
            let markerColor = "#999";
            if (amphoe.includes("‡∏£‡∏∞‡πÅ‡∏á‡∏∞")) markerColor = "#e74c3c";
            else if (amphoe.includes("‡∏à‡∏∞‡πÅ‡∏ô‡∏∞")) markerColor = "#f39c12";
            else if (amphoe.includes("‡∏™‡∏∏‡∏Ñ‡∏¥‡∏£‡∏¥‡∏ô")) markerColor = "#3498db";

            let tambonUnits = globalData.units.filter(u => u[5] === amphoe && u[6] === tambon);
            
            let aggScores = [0,0,0,0,0,0];
            let aggEligible = 0;
            let aggVoted = 0;
            
            tambonUnits.forEach(u => {
                aggEligible += (parseInt(u[4]) || 0);
                let uData = getUnitScores(u[0]);
                aggVoted += uData.voted;
                for(let k=0; k<6; k++) aggScores[k] += uData.scores[k];
            });
            
            let rankedAgg = aggScores.map((score, index) => ({ score, ...candidatesConfig[index] })).sort((a, b) => b.score - a.score);
            let percentAgg = aggEligible > 0 ? (aggVoted/aggEligible*100).toFixed(1) : 0;

            let viewsHTML = `
                <div id="view-overview-${uniqueId}" class="view-content">
                    <div class="d-flex justify-content-between bg-light p-2 rounded mb-2 text-center">
                         <div style="flex:1;">
                            <div class="fw-bold text-dark">${aggVoted.toLocaleString()}</div>
                            <small class="text-muted">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡∏ß‡∏°</small>
                         </div>
                         <div style="flex:1; border-left:1px solid #ddd;">
                            <div class="text-success fw-bold">${percentAgg}%</div>
                            <small class="text-muted">‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô</small>
                         </div>
                    </div>
                    ${rankedAgg.slice(0,3).map((c, i) => `
                        <div class="popup-row">
                            <div style="width:20px; color:#ccc;">#${i+1}</div>
                            <img src="${c.imgPopup}" class="popup-img">
                            <div class="flex-grow-1"><small>‡πÄ‡∏ö‡∏≠‡∏£‡πå ${c.no}</small> <br> <b>${c.name}</b></div>
                            <div class="fw-bold text-success">${c.score.toLocaleString()}</div>
                        </div>
                    `).join('')}
                </div>
            `;

            let buttonsHTML = `<div class="btn-overview-wrapper"><button class="btn-unit-select btn-overview active" onclick="switchPopupView('view-overview-${uniqueId}', this, '${uniqueId}')">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ï‡∏≥‡∏ö‡∏•</button></div>`;
            
            let filteredUnitsCount = tambonUnits.filter(u => u[0].trim().startsWith("‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà")).length;
            let alignmentStyle = filteredUnitsCount <= 6 ? 'justify-content: center;' : 'justify-content: flex-start;';

            buttonsHTML += `<div class="popup-unit-grid" style="${alignmentStyle}">`;

            tambonUnits.forEach((u, idx) => {
                let uName = u[0];
                if (!uName.trim().startsWith("‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà")) return;
                let match = uName.match(/\d+/);
                let unitLabel = match ? match[0] : "?"; 

                let uEligible = parseInt(u[4]) || 0;
                let uData = getUnitScores(uName);
                let uVoted = uData.voted;
                let uPercent = uEligible > 0 ? (uVoted/uEligible*100).toFixed(1) : 0;
                let uRanked = uData.scores.map((score, index) => ({ score, ...candidatesConfig[index] })).sort((a, b) => b.score - a.score);

                let viewId = `view-unit-${idx}-${uniqueId}`;
                buttonsHTML += `<button class="btn-unit-select" onclick="switchPopupView('${viewId}', this, '${uniqueId}')">${unitLabel}</button>`;

                viewsHTML += `
                    <div id="${viewId}" class="view-content" style="display:none;">
                        <div class="text-center mb-2 fw-bold text-primary">${uName}</div>
                        <div class="d-flex justify-content-between bg-light p-2 rounded mb-2 text-center">
                             <div style="flex:1;">
                                <div class="fw-bold text-dark">${uVoted.toLocaleString()}</div>
                                <small class="text-muted">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</small>
                             </div>
                             <div style="flex:1; border-left:1px solid #ddd;">
                                <div class="text-success fw-bold">${uPercent}%</div>
                                <small class="text-muted">‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô</small>
                             </div>
                        </div>
                        ${uRanked.slice(0,3).map((c, i) => `
                            <div class="popup-row">
                                <div style="width:20px; color:#ccc;">#${i+1}</div>
                                <img src="${c.imgPopup}" class="popup-img">
                                <div class="flex-grow-1"><small>‡πÄ‡∏ö‡∏≠‡∏£‡πå ${c.no}</small> <br> <b>${c.name}</b></div>
                                <div class="fw-bold text-success">${c.score.toLocaleString()}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            });
            buttonsHTML += `</div>`; 

            let popupContent = `
                <div id="${uniqueId}">
                    <div class="popup-header" style="background:${markerColor};">
                        <div style="font-size:1.25rem; font-weight:800; line-height:1.2;">${tambon}</div>
                        <div style="font-size:0.95rem; font-weight:400; margin-top:2px; opacity:0.9;">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠${amphoe}</div>
                    </div>
                    <div class="popup-unit-container">${buttonsHTML}</div>
                    <div class="popup-body">${viewsHTML}</div>
                </div>
            `;

            L.circleMarker([lat, lng], {
                radius: 8, fillColor: markerColor, color: "#ffffff", weight: 1.5, opacity: 1, fillOpacity: 1
            }).addTo(markersLayer).bindPopup(popupContent, { className: 'custom-popup' });
        }

        function updateSidebar(globalScores, totalEligible, totalVoted, progressPercent) {
            // 1. Turnout
            document.getElementById('totalTurnout').innerText = `${totalVoted.toLocaleString()} / ${totalEligible.toLocaleString()}`;
            let percent = totalEligible > 0 ? (totalVoted/totalEligible*100) : 0;
            document.getElementById('turnoutBar').style.width = `${percent}%`;
            document.getElementById('turnoutPercent').innerText = `${percent.toFixed(2)}%`;

            // 2. Counting Progress
            document.getElementById('countingDisplay').innerText = `${progressPercent.toFixed(1)}%`;
            document.getElementById('countingBar').style.width = `${progressPercent}%`;

            let ranked = globalScores.map((score, index) => ({ score, ...candidatesConfig[index] })).sort((a, b) => b.score - a.score);

            const top3Div = document.getElementById('top3List');
            top3Div.innerHTML = '';
            for(let i=0; i<3; i++) {
                let c = ranked[i];
                top3Div.innerHTML += `
                    <div class="card mb-2 border-0 shadow-sm rank-big">
                        <div class="card-body p-2 d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center flex-grow-1" style="min-width: 0;">
                                <div class="me-2 text-center" style="width:30px; flex-shrink: 0;"><h5 class="m-0 fw-bold text-warning">#${i+1}</h5></div>
                                <img src="${c.imgSidebar}" class="rank-img-big me-3">
                                <div class="text-start overflow-hidden">
                                    <div class="fw-bold text-dark text-truncate" style="font-size:0.9rem;">‡πÄ‡∏ö‡∏≠‡∏£‡πå ${c.no}</div>
                                    <div class="fw-bold text-secondary text-truncate" style="font-size:0.85rem;">${c.party}</div>
                                    <small class="text-muted text-truncate" style="font-size:0.75rem;">${c.name}</small>
                                </div>
                            </div>
                            <div class="text-end ps-2" style="flex-shrink: 0;">
                                <div class="fw-bolder text-primary" style="font-size: 1.6rem; line-height: 1;">${c.score.toLocaleString()}</div>
                                <small class="text-muted d-block" style="font-size: 0.7rem;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</small>
                            </div>
                        </div>
                    </div>`;
            }
            
            const next3Div = document.getElementById('next3List');
            next3Div.innerHTML = '';
            for(let i=3; i<6; i++) {
                let c = ranked[i];
                next3Div.innerHTML += `
                    <div class="d-flex align-items-center border-bottom py-2 justify-content-between">
                        <div class="d-flex align-items-center flex-grow-1" style="min-width: 0;">
                            <span class="me-3 text-muted fw-bold small text-center" style="width:30px; flex-shrink: 0;">#${i+1}</span>
                            <img src="${c.imgSidebar}" class="rank-img-small me-3">
                            <div class="text-start overflow-hidden" style="line-height: 1.3;">
                                <div class="fw-bold text-dark text-truncate" style="font-size:0.9rem;">‡πÄ‡∏ö‡∏≠‡∏£‡πå ${c.no}</div>
                                <small class="text-muted text-truncate" style="font-size:0.8rem;">${c.name}</small>
                            </div>
                        </div>
                        <span class="fw-bold text-primary fs-5 ps-2" style="flex-shrink: 0;">${c.score.toLocaleString()}</span>
                    </div>`;
            }
        }
    </script>
</body>
</html>

