<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Election Map</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; overflow: hidden; margin: 0; padding: 0; }
        
        #map { height: 100vh; width: 100%; background: #f4f7f6; z-index: 1; }
        
        /* ‡∏õ‡∏∏‡πà‡∏° Sidebar */
        .sidebar-toggle {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: white; border: none; padding: 12px 25px;
            border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            font-weight: bold; color: #2c3e50; cursor: pointer;
            transition: all 0.3s ease;
        }
        .sidebar-toggle:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }

        /* ‡∏õ‡∏∏‡πà‡∏° Reset Map */
        .reset-map-btn {
            position: absolute; top: 80px; right: 20px; z-index: 1000;
            background: white; border: none; width: 40px; height: 40px;
            border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            color: #333; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .reset-map-btn:hover { background: #f8f9fa; color: #000; }

        /* Sidebar Styling */
        .offcanvas-end { width: 420px; z-index: 2000; }
        @media (max-width: 576px) { .offcanvas-end { width: 95%; } }
        .bg-gradient-primary { background: linear-gradient(135deg, #2c3e50, #4ca1af); color: white; }

        /* Ranking Cards */
        .rank-card { transition: transform 0.2s; border: none; }
        .rank-card:hover { transform: scale(1.02); }
        .rank-big { background: #fff; border-left: 5px solid #f1c40f; }
        .rank-img-big { width: 65px; height: 65px; border-radius: 50%; object-fit: cover; border: 3px solid #f8f9fa; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
        .rank-img-small { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        
        /* Popup Styling */
        .custom-popup .leaflet-popup-content-wrapper { border-radius: 8px; padding: 0; box-shadow: 0 3px 14px rgba(0,0,0,0.2); }
        .custom-popup .leaflet-popup-content { margin: 0; width: 280px !important; }
        .popup-header { background: #2c3e50; color: white; padding: 12px 15px; font-weight: bold; font-size: 1.1em; border-radius: 8px 8px 0 0; }
        .popup-body { padding: 15px; }
        .popup-row { display: flex; align-items: center; padding: 6px 0; border-bottom: 1px solid #f1f1f1; }

        /* Legend */
        .map-legend {
            position: absolute; bottom: 30px; left: 30px; z-index: 1000;
            background: rgba(255,255,255,0.95); padding: 15px 20px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); font-size: 0.9em;
            border-left: 4px solid #28a745; backdrop-filter: blur(5px);
        }
        .color-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
    </style>
</head>
<body>

    <button class="sidebar-toggle" type="button" data-bs-toggle="offcanvas" data-bs-target="#rightSidebar">
        <i class="fas fa-chart-pie me-2"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
    </button>

    <button class="reset-map-btn" type="button" onclick="resetMapView()" title="‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥">
        <i class="fas fa-compress-arrows-alt"></i>
    </button>

    <div class="map-legend">
        <div class="fw-bold mb-2 text-dark">‡πÄ‡∏Ç‡∏ï‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡∏π‡∏°)</div>
        <div class="mb-1"><span class="color-dot" style="background:#e74c3c;"></span> ‡∏≠.‡∏£‡∏∞‡πÅ‡∏á‡∏∞</div>
        <div class="mb-1"><span class="color-dot" style="background:#f39c12;"></span> ‡∏≠.‡∏à‡∏∞‡πÅ‡∏ô‡∏∞</div>
        <div class="mb-1"><span class="color-dot" style="background:#3498db;"></span> ‡∏≠.‡∏™‡∏∏‡∏Ñ‡∏¥‡∏£‡∏¥‡∏ô</div>
        <div class="mt-3 text-muted small border-top pt-2">
            <i class="fas fa-circle text-success"></i> ‡∏à‡∏∏‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á
        </div>
    </div>

    <div id="map"></div>

    <div class="offcanvas offcanvas-end show" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1" id="rightSidebar">
        <div class="offcanvas-header bg-gradient-primary">
            <h5 class="offcanvas-title"><i class="fas fa-vote-yea me-2"></i> Dashboard ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏î</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body bg-light">
            <div class="card mb-4 border-0 shadow-sm rounded-4 bg-white">
                <div class="card-body text-center p-4">
                    <h6 class="text-secondary text-uppercase small fw-bold ls-1">‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡∏ß‡∏°</h6>
                    <h2 class="fw-bold text-dark my-2" id="totalTurnout">...</h2>
                    <div class="progress rounded-pill bg-light mt-3" style="height: 10px;">
                        <div class="progress-bar bg-gradient-primary" id="turnoutBar" style="width: 0%"></div>
                    </div>
                    <div class="mt-2 text-end text-muted small fw-bold" id="turnoutPercent">0%</div>
                </div>
            </div>
            <h6 class="fw-bold text-secondary text-uppercase small mb-3 ls-1">üèÜ 3 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å</h6>
            <div id="top3List"></div>
            <h6 class="fw-bold text-secondary text-uppercase small mb-3 mt-4 ls-1">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÜ</h6>
            <div id="next3List"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxjGKqtdINH8KQIH4exj3qyE2zdsNNDj9Mm5x7kWyFI-UgJ9a2zsbFKXpzffOtpm1ea_Q/exec'; // <--- ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL
        
        const candidatesConfig = [
            { no: 1, name: "‡πÄ‡∏ö‡∏≠‡∏£‡πå 1", color: "#0d6efd", img: "https://img2.pic.in.th/1350d68330953409d.png" },
            { no: 2, name: "‡πÄ‡∏ö‡∏≠‡∏£‡πå 2", color: "#198754", img: "https://img5.pic.in.th/file/secure-sv1/2e202bb41458cf2b1.png" },
            { no: 3, name: "‡πÄ‡∏ö‡∏≠‡∏£‡πå 3", color: "#dc3545", img: "https://img2.pic.in.th/315d39fe9e514ce03.png" },
            { no: 4, name: "‡πÄ‡∏ö‡∏≠‡∏£‡πå 4", color: "#fd7e14", img: "https://img5.pic.in.th/file/secure-sv1/48e77349737a85eda.png" },
            { no: 5, name: "‡πÄ‡∏ö‡∏≠‡∏£‡πå 5", color: "#0dcaf0", img: "https://img2.pic.in.th/5b028fab05d845d6a.png" },
            { no: 6, name: "‡πÄ‡∏ö‡∏≠‡∏£‡πå 6", color: "#6f42c1", img: "https://img2.pic.in.th/69adc3cca999bb66d.png" }
        ];
        // ============================================

        const map = L.map('map', { zoomControl: false }).setView([6.05, 101.80], 10);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        let geojsonLayer; // ‡πÄ‡∏Å‡πá‡∏ö Layer ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ Reset

        loadBoundaries();
        fetchData();

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Reset ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        function resetMapView() {
            if (geojsonLayer) {
                map.fitBounds(geojsonLayer.getBounds());
            }
        }

        async function loadBoundaries() {
            try {
                const geoUrl = 'https://raw.githubusercontent.com/jitlogo/thailand-geojson/master/amphoe.geojson';
                const response = await fetch(geoUrl);
                const geoData = await response.json();

                geojsonLayer = L.geoJSON(geoData, {
                    filter: function(feature) {
                        const props = JSON.stringify(feature.properties).toLowerCase();
                        return (props.includes('ra-ngae') || props.includes('‡∏£‡∏∞‡πÅ‡∏á‡∏∞')) ||
                               (props.includes('chanae') || props.includes('‡∏à‡∏∞‡πÅ‡∏ô‡∏∞')) ||
                               (props.includes('sukhirin') || props.includes('‡∏™‡∏∏‡∏Ñ‡∏¥‡∏£‡∏¥‡∏ô'));
                    },
                    style: function(feature) {
                        const props = JSON.stringify(feature.properties).toLowerCase();
                        let color = '#3388ff';
                        
                        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ 3 ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
                        if (props.includes('ra-ngae') || props.includes('‡∏£‡∏∞‡πÅ‡∏á‡∏∞')) color = '#e74c3c'; // ‡πÅ‡∏î‡∏á
                        else if (props.includes('chanae') || props.includes('‡∏à‡∏∞‡πÅ‡∏ô‡∏∞')) color = '#f39c12'; // ‡∏™‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
                        else if (props.includes('sukhirin') || props.includes('‡∏™‡∏∏‡∏Ñ‡∏¥‡∏£‡∏¥‡∏ô')) color = '#3498db'; // ‡∏ü‡πâ‡∏≤

                        return {
                            color: 'white',    // ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß
                            weight: 2,         
                            fillColor: color,  
                            fillOpacity: 0.25, // ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏à‡∏≤‡∏á‡πÜ
                            dashArray: '3'     // ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏°‡∏µ‡∏°‡∏¥‡∏ï‡∏¥
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        const name = feature.properties.NAME_TH || feature.properties.NAME_2;
                        
                        // 1. Tooltip ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠
                        layer.bindTooltip(name, {
                            permanent: true,
                            direction: 'center',
                            className: 'bg-transparent border-0 fw-bold text-secondary shadow-none'
                        });

                        // 2. Event Listeners (‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå + ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ã‡∏π‡∏°)
                        layer.on({
                            mouseover: function(e) {
                                var layer = e.target;
                                layer.setStyle({
                                    weight: 4,
                                    fillOpacity: 0.5, // ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡πâ
                                    color: '#666',
                                    dashArray: ''
                                });
                            },
                            mouseout: function(e) {
                                geojsonLayer.resetStyle(e.target); // ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏™‡∏†‡∏≤‡∏û‡πÄ‡∏î‡∏¥‡∏°
                            },
                            click: function(e) {
                                // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ Map ‡∏ã‡∏π‡∏°‡πÑ‡∏õ‡∏´‡∏≤‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏Ç‡∏≠‡∏á‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ô‡∏±‡πâ‡∏ô
                                map.fitBounds(e.target.getBounds());
                            }
                        });
                    }
                }).addTo(map);

                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ã‡∏π‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á 3 ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠
                if (geojsonLayer.getLayers().length > 0) {
                   map.fitBounds(geojsonLayer.getBounds());
                }

            } catch (err) {
                console.error("GeoJSON Error:", err);
            }
        }

        async function fetchData() {
            try {
                const response = await fetch(scriptURL);
                if (!response.ok) throw new Error('Connect Failed');
                const data = await response.json();
                processData(data);
            } catch (error) {
                console.error("Fetch Error:", error);
            }
        }

        function processData(data) {
            const units = data.units;
            const scores = data.scores;
            let globalScores = [0,0,0,0,0,0];
            let totalEligible = 0;
            let totalVoted = 0;

            units.forEach(unit => {
                const unitName = unit[0];
                const lat = parseFloat(unit[2]);
                const lng = parseFloat(unit[3]);
                const unitVoters = parseInt(unit[4]) || 0;
                totalEligible += unitVoters;

                const unitScoresLog = scores.filter(row => row[1] === unitName);
                let currentScores = [0,0,0,0,0,0];
                let votedCount = 0;

                if (unitScoresLog.length > 0) {
                    const latest = unitScoresLog[unitScoresLog.length - 1];
                    for(let i=0; i<6; i++) {
                        let sc = parseInt(latest[3+i]) || 0;
                        currentScores[i] = sc;
                        globalScores[i] += sc;
                        votedCount += sc;
                    }
                    totalVoted += votedCount;
                }

                if (!isNaN(lat) && !isNaN(lng)) {
                    createMarker(lat, lng, unitName, currentScores, unitVoters, votedCount);
                }
            });

            updateSidebar(globalScores, totalEligible, totalVoted);
        }

        function createMarker(lat, lng, name, scores, eligible, voted) {
            let ranked = scores.map((score, index) => ({ score, ...candidatesConfig[index] }))
                               .sort((a, b) => b.score - a.score);
            let percent = eligible > 0 ? (voted/eligible*100).toFixed(1) : 0;

            let popupContent = `
                <div class="popup-header">${name}</div>
                <div class="popup-body">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:0.9em; background:#f8f9fa; padding:8px; border-radius:5px;">
                        <span><i class="fas fa-users"></i> ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</span>
                        <span class="fw-bold text-success">${voted.toLocaleString()} / ${eligible.toLocaleString()} (${percent}%)</span>
                    </div>
            `;
            
            for(let i=0; i<3; i++) {
                let c = ranked[i];
                popupContent += `
                    <div class="popup-row">
                        <div class="me-3 fw-bold text-secondary">#${i+1}</div>
                        <img src="${c.img}" style="width:35px; height:35px; border-radius:50%; margin-right:10px;">
                        <div class="flex-grow-1">
                            <div style="font-size:0.85em; color:#666;">‡πÄ‡∏ö‡∏≠‡∏£‡πå ${c.no}</div>
                            <div class="fw-bold text-dark" style="font-size:0.95em;">${c.name}</div>
                        </div>
                        <div class="fw-bold text-primary">${c.score.toLocaleString()}</div>
                    </div>
                `;
            }
            popupContent += `</div>`;

            L.circleMarker([lat, lng], {
                radius: 5,
                fillColor: "#28a745", // ‡∏à‡∏∏‡∏î‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                color: "#ffffff",
                weight: 1.5,
                opacity: 1,
                fillOpacity: 1
            }).addTo(map).bindPopup(popupContent, { className: 'custom-popup' });
        }

        function updateSidebar(globalScores, totalEligible, totalVoted) {
            document.getElementById('totalTurnout').innerText = `${totalVoted.toLocaleString()} / ${totalEligible.toLocaleString()}`;
            let percent = totalEligible > 0 ? (totalVoted/totalEligible*100) : 0;
            document.getElementById('turnoutBar').style.width = `${percent}%`;
            document.getElementById('turnoutPercent').innerText = `${percent.toFixed(2)}%`;

            let ranked = globalScores.map((score, index) => ({ score, ...candidatesConfig[index] }))
                                     .sort((a, b) => b.score - a.score);

            const top3Div = document.getElementById('top3List');
            top3Div.innerHTML = '';
            for(let i=0; i<3; i++) {
                let c = ranked[i];
                top3Div.innerHTML += `
                    <div class="card mb-2 rank-card rank-big shadow-sm">
                        <div class="card-body p-3 d-flex align-items-center">
                            <div class="me-3 text-center" style="min-width: 40px;">
                                <h4 class="m-0 fw-bold text-warning">#${i+1}</h4>
                            </div>
                            <img src="${c.img}" class="rank-img-big me-3">
                            <div class="flex-grow-1">
                                <h6 class="m-0 fw-bold text-dark">‡πÄ‡∏ö‡∏≠‡∏£‡πå ${c.no}</h6>
                                <small class="text-muted">${c.name}</small>
                            </div>
                            <div class="text-end">
                                <h5 class="fw-bold m-0 text-dark">${c.score.toLocaleString()}</h5>
                            </div>
                        </div>
                    </div>
                `;
            }

            const next3Div = document.getElementById('next3List');
            next3Div.innerHTML = '';
            for(let i=3; i<6; i++) {
                let c = ranked[i];
                next3Div.innerHTML += `
                    <div class="d-flex align-items-center border-bottom py-2">
                        <span class="me-3 text-muted fw-bold small" style="width:20px;">#${i+1}</span>
                        <img src="${c.img}" class="rank-img-small me-3">
                        <div class="flex-grow-1 small">
                            <span class="fw-bold text-dark">‡πÄ‡∏ö‡∏≠‡∏£‡πå ${c.no}</span>
                        </div>
                        <span class="fw-bold text-dark">${c.score.toLocaleString()}</span>
                    </div>
                `;
            }
        }
    </script>
</body>

</html>

