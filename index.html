<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2569 ‡πÄ‡∏Ç‡∏ï 4 ‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700;800&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            overflow: hidden; margin: 0; padding: 0;
            display: flex; flex-direction: column; height: 100vh;
        }

        /* --- Header --- */
        .top-header {
            height: auto; min-height: 70px; /* ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô */
            background: #2c3e50; color: white;
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 2000; flex-shrink: 0; gap: 15px;
        }

        .brand-section { display: flex; align-items: center; min-width: fit-content; }
        .brand-text { display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 1.3rem; }

        /* Controls Container */
        .right-controls { 
            display: flex; align-items: center; gap: 15px; 
            flex-grow: 1; justify-content: flex-end; /* ‡∏î‡∏±‡∏ô‡πÑ‡∏õ‡∏Ç‡∏ß‡∏≤ */
            overflow: hidden; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏•‡πâ‡∏ô */
        }

        /* --- New: Amphoe Buttons Style --- */
        .amphoe-group {
            display: flex; gap: 5px;
            background: rgba(255,255,255,0.1);
            padding: 4px; border-radius: 30px;
            overflow-x: auto; /* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            white-space: nowrap;
            scrollbar-width: none; /* ‡∏ã‡πà‡∏≠‡∏ô Scrollbar Firefox */
        }
        .amphoe-group::-webkit-scrollbar { display: none; /* ‡∏ã‡πà‡∏≠‡∏ô Scrollbar Chrome */ }

        .btn-filter {
            background: transparent; border: none;
            color: rgba(255,255,255,0.8);
            padding: 6px 15px; border-radius: 20px;
            font-size: 0.9rem; font-weight: bold;
            cursor: pointer; transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-filter:hover { color: white; background: rgba(255,255,255,0.1); }
        
        .btn-filter.active {
            background: white; color: #2c3e50;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Divider */
        .divider { width: 1px; height: 25px; background: rgba(255,255,255,0.2); margin: 0 5px; flex-shrink: 0; }

        /* Tambon Dropdown Style */
        .tambon-wrapper {
            position: relative;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px; padding: 0 10px;
            display: flex; align-items: center;
            min-width: 140px;
        }
        .custom-select {
            background: transparent; border: none;
            color: white; font-weight: bold; font-size: 0.95rem;
            padding: 6px 25px 6px 10px; /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏®‡∏£ */
            cursor: pointer; outline: none;
            appearance: none; width: 100%;
        }
        .custom-select option { color: #333; }
        .custom-select:disabled { color: rgba(255,255,255,0.4); cursor: not-allowed; }
        .dropdown-icon { position: absolute; right: 10px; font-size: 0.8em; opacity: 0.7; pointer-events: none; }

        .btn-toggle-sidebar {
            background: #f1c40f; color: #2c3e50; border: none;
            padding: 8px 20px; border-radius: 50px; font-weight: bold;
            transition: 0.2s; box-shadow: 0 4px 10px rgba(241, 196, 15, 0.3);
            white-space: nowrap;
        }

        /* --- Map & Sidebar --- */
        #map { flex-grow: 1; width: 100%; background: #f8f9fa; z-index: 1; }
        .map-legend {
            position: absolute; bottom: 30px; left: 30px; z-index: 1000;
            background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); font-size: 0.9em; border-left: 5px solid #2c3e50;
        }
        .color-dot { display: inline-block; width: 15px; height: 15px; border-radius: 3px; margin-right: 8px; vertical-align: middle; }

        .custom-popup .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; }
        .custom-popup .leaflet-popup-content { margin: 0; width: 300px !important; }
        .popup-header { background: #2c3e50; color: white; padding: 12px 15px; }
        .popup-body { padding: 15px; background: #fff; }
        .popup-row { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .popup-img { width: 40px; height: 40px; object-fit: contain; margin-right: 10px; }

        .offcanvas-end { 
            width: 420px; z-index: 3000; 
            top: 70px !important; bottom: 0 !important; height: auto !important; 
            border-left: 1px solid #ddd;
        }
        .offcanvas-body { display: flex; flex-direction: column; padding: 0; overflow: hidden; }
        .ranking-scroll-area { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .stats-fixed-bottom { flex-shrink: 0; background: #fff; padding: 15px 20px 30px 20px; border-top: 1px solid #eee; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); }

        .rank-big { background: #fff; border-left: 5px solid #f1c40f; }
        .rank-img-big { width: 80px; height: auto; object-fit: contain; border: none; }
        .rank-img-small { width: 45px; height: auto; object-fit: contain; border-radius: 0; }

        @media (max-width: 768px) { 
            .top-header { flex-direction: column; padding: 15px; gap: 15px; align-items: stretch; }
            .brand-section { justify-content: center; }
            .brand-icon { display: none; }
            .brand-text { flex-direction: column; align-items: center; gap: 2px; line-height: 1.2; }
            
            .right-controls { 
                flex-direction: row; flex-wrap: wrap; 
                justify-content: space-between; width: 100%; 
            }
            .amphoe-group { flex-basis: 100%; order: 1; justify-content: space-between; margin-bottom: 5px; }
            .btn-filter { flex-grow: 1; text-align: center; }
            
            .divider { display: none; } /* ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏Ñ‡∏±‡πà‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            
            .tambon-wrapper { flex-grow: 1; order: 2; margin-right: 10px; }
            .btn-toggle-sidebar { order: 3; }

            .offcanvas-end { width: 100%; top: 160px !important; }
            .map-legend { display: none; }
        }
    </style>
</head>
<body>

    <div class="top-header">
        <div class="brand-section">
            <i class="fas fa-vote-yea me-3 text-warning brand-icon" style="font-size: 1.5rem;"></i>
            <div class="brand-text">
                <span class="line-1">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á ‡∏™.‡∏™. 2569</span>
                <span class="line-2">‡πÄ‡∏Ç‡∏ï 4 ‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™</span>
            </div>
        </div>

        <div class="right-controls">
            <div id="amphoeGroup" class="amphoe-group">
                </div>

            <div class="divider"></div>

            <div class="tambon-wrapper">
                <select id="selectTambon" class="custom-select" onchange="filterData()" disabled>
                    <option value="all">üö© ‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>
                </select>
                <i class="fas fa-chevron-down text-white dropdown-icon"></i>
            </div>

            <button class="btn-toggle-sidebar" type="button" data-bs-toggle="offcanvas" data-bs-target="#rightSidebar">
                <i class="fas fa-list-ol me-2"></i> ‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            </button>
        </div>
    </div>

    <div id="map"></div>

    <div class="map-legend">
        <div class="fw-bold mb-2">‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå</div>
        <div class="mb-1"><span class="color-dot" style="background:#e74c3c;"></span> ‡∏≠.‡∏£‡∏∞‡πÅ‡∏á‡∏∞</div>
        <div class="mb-1"><span class="color-dot" style="background:#f39c12;"></span> ‡∏≠.‡∏à‡∏∞‡πÅ‡∏ô‡∏∞</div>
        <div class="mb-1"><span class="color-dot" style="background:#3498db;"></span> ‡∏≠.‡∏™‡∏∏‡∏Ñ‡∏¥‡∏£‡∏¥‡∏ô</div>
    </div>

    <div class="offcanvas offcanvas-end show" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1" id="rightSidebar">
        <div class="offcanvas-header bg-light border-bottom">
            <h5 class="offcanvas-title text-dark fw-bold"><i class="fas fa-trophy text-warning me-2"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body bg-light">
            <div class="ranking-scroll-area">
                <h6 class="fw-bold text-secondary small mb-3">üèÜ 3 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å (‡∏ï‡∏≤‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</h6>
                <div id="top3List"></div>
                <h6 class="fw-bold text-secondary small mb-3 mt-4">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÜ</h6>
                <div id="next3List"></div>
            </div>
            <div class="stats-fixed-bottom">
                <div class="card border-0 shadow-sm rounded-4 bg-white">
                    <div class="card-body text-center p-3">
                        <small class="text-uppercase text-muted fw-bold" style="font-size:0.8em;">
                            <i class="fas fa-users"></i> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (‡∏ï‡∏≤‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
                        </small>
                        <h2 class="fw-bold text-dark my-1" id="totalTurnout">...</h2>
                        <div class="progress rounded-pill bg-light mt-2" style="height: 8px;">
                            <div class="progress-bar bg-success" id="turnoutBar" style="width: 0%"></div>
                        </div>
                        <small id="turnoutPercent" class="fw-bold text-success">0%</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxjGKqtdINH8KQIH4exj3qyE2zdsNNDj9Mm5x7kWyFI-UgJ9a2zsbFKXpzffOtpm1ea_Q/exec';
        
        // ‚ö†Ô∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Party Name ‡πÅ‡∏•‡∏∞ Candidate Name ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚ö†Ô∏è
        const candidatesConfig = [
            { 
                no: 1, 
                party: "‡∏û‡∏£‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏≤‡∏ï‡∏¥",       // ‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏£‡∏£‡∏Ñ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                name: "‡∏ô‡∏≤‡∏¢‡∏Å‡∏π‡πÄ‡∏Æ‡∏á ‡∏¢‡∏≤‡∏ß‡∏≠‡∏´‡∏∞‡∏ã‡∏±‡∏ô", // ‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                imgSidebar: "https://img2.pic.in.th/14746ae2e943b791f.png", 
                imgPopup: "https://img2.pic.in.th/1350d68330953409d.png" 
            },
            { 
                no: 2, 
                party: "‡∏û‡∏£‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ò‡∏¥‡∏õ‡∏±‡∏ï‡∏¢‡πå",
                name: "‡∏ô‡∏≤‡∏¢‡∏Å‡∏≠‡πÄ‡∏ã‡πá‡∏á ‡∏°‡∏∞‡πÄ‡∏ã‡πá‡∏á",
                imgSidebar: "https://img5.pic.in.th/file/secure-sv1/2f20164de60a3b0c8.png", 
                imgPopup: "https://img5.pic.in.th/file/secure-sv1/2e202bb41458cf2b1.png" 
            },
            { 
                no: 3, 
                party: "‡∏û‡∏£‡∏£‡∏Ñ‡∏Å‡∏•‡πâ‡∏≤‡∏ò‡∏£‡∏£‡∏°",
                name: "‡∏ô‡∏≤‡∏¢‡∏≠‡∏î‡∏¥‡∏®‡∏£ ‡∏≠‡∏≤‡πÅ‡∏ß‡πÄ‡∏ï‡πä‡∏∞",
                imgSidebar: "https://img2.pic.in.th/31703a588faa60731.jpg", 
                imgPopup: "https://img2.pic.in.th/315d39fe9e514ce03.png" 
            },
            { 
                no: 4, 
                party: "‡∏û‡∏£‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô",
                name: "‡∏ô‡∏≤‡∏¢‡∏≠‡∏±‡∏Å‡∏ö‡∏±‡∏£ ‡πÄ‡∏ã‡∏£‡∏≤‡∏•‡∏µ",
                imgSidebar: "https://img5.pic.in.th/file/secure-sv1/47d4ceea9d498867b.png", 
                imgPopup: "https://img5.pic.in.th/file/secure-sv1/48e77349737a85eda.png" 
            },
            { 
                no: 5, 
                party: "‡∏û‡∏£‡∏£‡∏Ñ‡∏†‡∏π‡∏°‡∏¥‡πÉ‡∏à‡πÑ‡∏ó‡∏¢",
                name: "‡∏ô‡∏≤‡∏¢‡∏ã‡∏≤‡∏Å‡∏≤‡∏£‡∏µ‡∏¢‡∏≤ ‡∏™‡∏∞‡∏≠‡∏¥",
                imgSidebar: "https://img2.pic.in.th/51fe81d8bbda133aa.png", 
                imgPopup: "https://img2.pic.in.th/5b028fab05d845d6a.png" 
            },
            { 
                no: 6, 
                party: "‡∏û‡∏£‡∏£‡∏Ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢",
                name: "‡∏ô‡∏≤‡∏¢‡∏°‡∏≤‡∏£‡πå‡∏ß‡∏≤‡∏ô ‡∏ö‡∏¥‡∏ô‡∏ö‡∏µ‡∏î‡∏µ",
                imgSidebar: "https://img2.pic.in.th/69adc3cca999bb66d.png", 
                imgPopup: "https://img2.pic.in.th/69adc3cca999bb66d.png" 
            }
        ];

        const map = L.map('map', { zoomControl: false }).setView([6.05, 101.80], 10);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        let geojsonLayer;
        let markersLayer = L.layerGroup().addTo(map);
        let globalData = null;
        let currentAmphoe = 'all'; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å

        loadBoundaries();
        fetchData();

        async function loadBoundaries() {
            try {
                const geoUrl = 'https://raw.githubusercontent.com/jitlogo/thailand-geojson/master/amphoe.geojson';
                const response = await fetch(geoUrl);
                const geoData = await response.json();

                geojsonLayer = L.geoJSON(geoData, {
                    filter: function(feature) {
                        const props = JSON.stringify(feature.properties).toLowerCase();
                        return (props.includes('ra-ngae') || props.includes('‡∏£‡∏∞‡πÅ‡∏á‡∏∞')) ||
                               (props.includes('chanae') || props.includes('‡∏à‡∏∞‡πÅ‡∏ô‡∏∞')) ||
                               (props.includes('sukhirin') || props.includes('‡∏™‡∏∏‡∏Ñ‡∏¥‡∏£‡∏¥‡∏ô'));
                    },
                    style: function(feature) {
                        const props = JSON.stringify(feature.properties).toLowerCase();
                        let color = '#999';
                        if (props.includes('ra-ngae')) color = '#e74c3c';
                        else if (props.includes('chanae')) color = '#f39c12';
                        else if (props.includes('sukhirin')) color = '#3498db';
                        return { color: 'white', weight: 2, opacity: 1, fillColor: color, fillOpacity: 0.2 };
                    },
                    onEachFeature: function(feature, layer) {
                        layer.bindTooltip(feature.properties.NAME_TH || feature.properties.NAME_2, {
                            permanent: true, direction: 'center', className: 'bg-transparent border-0 fw-bold text-dark shadow-none'
                        });
                        layer.on('click', function(e) { map.fitBounds(e.target.getBounds()); });
                    }
                }).addTo(map);
                if (geojsonLayer.getLayers().length > 0) map.fitBounds(geojsonLayer.getBounds());
            } catch (err) { console.error(err); }
        }

        async function fetchData() {
            try {
                const response = await fetch(scriptURL);
                globalData = await response.json();
                initFilterButtons(globalData.units); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ó‡∏ô
                filterData();
            } catch (error) { console.error("Fetch Error:", error); }
        }

        // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ó‡∏ô Dropdown ---
        function initFilterButtons(units) {
            const amphoeSet = new Set();
            units.forEach(u => { if(u[5]) amphoeSet.add(u[5]); });

            const btnContainer = document.getElementById('amphoeGroup');
            
            // 1. ‡∏õ‡∏∏‡πà‡∏° "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
            let allBtn = document.createElement('button');
            allBtn.className = 'btn-filter active';
            allBtn.innerText = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
            allBtn.onclick = () => selectAmphoe('all', allBtn);
            btnContainer.appendChild(allBtn);

            // 2. ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ï‡πà‡∏≤‡∏á‡πÜ
            amphoeSet.forEach(amp => {
                let btn = document.createElement('button');
                btn.className = 'btn-filter';
                btn.innerText = amp;
                btn.onclick = () => selectAmphoe(amp, btn);
                btnContainer.appendChild(btn);
            });
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ---
        function selectAmphoe(amphoe, btnElement) {
            currentAmphoe = amphoe;

            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Active Class
            document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');

            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dropdown ‡∏ï‡∏≥‡∏ö‡∏•
            const selectTambon = document.getElementById('selectTambon');
            selectTambon.innerHTML = '<option value="all">üö© ‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>';
            selectTambon.value = 'all';

            if (currentAmphoe === 'all') {
                selectTambon.disabled = true;
                if (geojsonLayer) map.fitBounds(geojsonLayer.getBounds());
            } else {
                selectTambon.disabled = false;
                const tambonSet = new Set();
                globalData.units.forEach(u => {
                    if (u[5] === currentAmphoe && u[6]) tambonSet.add(u[6]);
                });
                tambonSet.forEach(tam => {
                    let opt = document.createElement('option');
                    opt.value = tam;
                    opt.text = tam;
                    selectTambon.appendChild(opt);
                });
                
                // Zoom ‡πÑ‡∏õ‡∏´‡∏≤‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ô‡∏±‡πâ‡∏ô (‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏¥‡∏°)
                if (geojsonLayer) {
                    geojsonLayer.eachLayer(function(layer) {
                        const props = JSON.stringify(layer.feature.properties).toLowerCase();
                        let mapName = "";
                        if(currentAmphoe.includes("‡∏£‡∏∞‡πÅ‡∏á‡∏∞")) mapName = "ra-ngae";
                        else if(currentAmphoe.includes("‡∏à‡∏∞‡πÅ‡∏ô‡∏∞")) mapName = "chanae";
                        else if(currentAmphoe.includes("‡∏™‡∏∏‡∏Ñ‡∏¥‡∏£‡∏¥‡∏ô")) mapName = "sukhirin";
                        if(mapName && props.includes(mapName)) {
                            map.fitBounds(layer.getBounds());
                        }
                    });
                }
            }

            filterData();
        }

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å ---
        function filterData() {
            if (!globalData) return;

            const selectedAmphoe = currentAmphoe; // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global
            const selectTambon = document.getElementById('selectTambon');
            const selectedTambon = selectTambon.value;

            let filteredUnits = globalData.units.filter(u => {
                let matchAmphoe = (selectedAmphoe === 'all') || (u[5] === selectedAmphoe);
                let matchTambon = (selectedTambon === 'all') || (u[6] === selectedTambon);
                return matchAmphoe && matchTambon;
            });

            calculateAndRender(filteredUnits, globalData.scores);

            // Zoom Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡∏ö‡∏•
            if (selectedTambon !== 'all') {
                if (filteredUnits.length > 0) {
                    let latlngs = [];
                    filteredUnits.forEach(u => {
                        let lat = parseFloat(u[2]);
                        let lng = parseFloat(u[3]);
                        if(!isNaN(lat) && !isNaN(lng)) latlngs.push([lat, lng]);
                    });
                    if (latlngs.length > 0) {
                        let bounds = L.latLngBounds(latlngs);
                        map.fitBounds(bounds, { padding: [50, 50], maxZoom: 14 });
                    }
                }
            }
        }

        function calculateAndRender(units, scores) {
            markersLayer.clearLayers();

            let globalScores = [0,0,0,0,0,0];
            let totalEligible = 0;
            let totalVoted = 0;

            units.forEach(unit => {
                const unitName = unit[0];
                const lat = parseFloat(unit[2]);
                const lng = parseFloat(unit[3]);
                const unitVoters = parseInt(unit[4]) || 0;
                const amphoe = unit[5] || '-';
                const tambon = unit[6] || '-';

                totalEligible += unitVoters;

                const unitScoresLog = scores.filter(row => row[1] === unitName);
                let currentScores = [0,0,0,0,0,0];
                let votedCount = 0;

                if (unitScoresLog.length > 0) {
                    const latest = unitScoresLog[unitScoresLog.length - 1];
                    for(let i=0; i<6; i++) {
                        let sc = parseInt(latest[5+i]) || 0; 
                        currentScores[i] = sc;
                        globalScores[i] += sc; 
                        votedCount += sc;
                    }
                    totalVoted += votedCount;
                }

                if (!isNaN(lat) && !isNaN(lng)) {
                    createMarker(lat, lng, unitName, amphoe, tambon, currentScores, unitVoters, votedCount);
                }
            });

            updateSidebar(globalScores, totalEligible, totalVoted);
        }

        function createMarker(lat, lng, name, amphoe, tambon, scores, eligible, voted) {
            let ranked = scores.map((score, index) => ({ score, ...candidatesConfig[index] })).sort((a, b) => b.score - a.score);
            let percent = eligible > 0 ? (voted/eligible*100).toFixed(1) : 0;

            let markerColor = "#999";
            if (amphoe.includes("‡∏£‡∏∞‡πÅ‡∏á‡∏∞")) markerColor = "#e74c3c";
            else if (amphoe.includes("‡∏à‡∏∞‡πÅ‡∏ô‡∏∞")) markerColor = "#f39c12";
            else if (amphoe.includes("‡∏™‡∏∏‡∏Ñ‡∏¥‡∏£‡∏¥‡∏ô")) markerColor = "#3498db";

            let popupContent = `
                <div class="popup-header" style="background:${markerColor};">
                    <span class="badge bg-light text-dark mb-1">‡∏≠.${amphoe} / ‡∏ï.${tambon}</span>
                    <div class="popup-unit-name">${name}</div>
                </div>
                <div class="popup-body">
                    <div class="d-flex justify-content-between bg-light p-2 rounded mb-2">
                         <span>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: <b>${voted.toLocaleString()}</b></span>
                         <span class="text-success fw-bold">${percent}%</span>
                    </div>`;
            
            for(let i=0; i<3; i++) {
                let c = ranked[i];
                popupContent += `
                    <div class="popup-row">
                        <div style="width:20px; color:#ccc;">#${i+1}</div>
                        <img src="${c.imgPopup}" class="popup-img">
                        <div class="flex-grow-1"><small>‡πÄ‡∏ö‡∏≠‡∏£‡πå ${c.no}</small> <br> <b>${c.name}</b></div>
                        <div class="fw-bold text-success">${c.score.toLocaleString()}</div>
                    </div>`;
            }
            popupContent += `</div>`;

            L.circleMarker([lat, lng], {
                radius: 6, fillColor: markerColor, color: "#ffffff", weight: 1.5, opacity: 1, fillOpacity: 1
            }).addTo(markersLayer).bindPopup(popupContent, { className: 'custom-popup' });
        }

        function updateSidebar(globalScores, totalEligible, totalVoted) {
            document.getElementById('totalTurnout').innerText = `${totalVoted.toLocaleString()} / ${totalEligible.toLocaleString()}`;
            let percent = totalEligible > 0 ? (totalVoted/totalEligible*100) : 0;
            document.getElementById('turnoutBar').style.width = `${percent}%`;
            document.getElementById('turnoutPercent').innerText = `${percent.toFixed(2)}%`;

            let ranked = globalScores.map((score, index) => ({ score, ...candidatesConfig[index] })).sort((a, b) => b.score - a.score);

            const top3Div = document.getElementById('top3List');
            top3Div.innerHTML = '';
            for(let i=0; i<3; i++) {
                let c = ranked[i];
                top3Div.innerHTML += `
                    <div class="card mb-2 border-0 shadow-sm rank-big">
                        <div class="card-body p-2 d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center flex-grow-1" style="min-width: 0;">
                                <div class="me-2 text-center" style="width:30px; flex-shrink: 0;"><h5 class="m-0 fw-bold text-warning">#${i+1}</h5></div>
                                <img src="${c.imgSidebar}" class="rank-img-big me-3">
                                <div class="text-start overflow-hidden">
                                    <div class="fw-bold text-dark text-truncate" style="font-size:0.9rem;">‡πÄ‡∏ö‡∏≠‡∏£‡πå ${c.no}</div>
                                    <div class="fw-bold text-secondary text-truncate" style="font-size:0.85rem;">${c.party}</div>
                                    <small class="text-muted text-truncate" style="font-size:0.75rem;">${c.name}</small>
                                </div>
                            </div>
                            <div class="text-end ps-2" style="flex-shrink: 0;">
                                <div class="fw-bolder text-primary" style="font-size: 1.6rem; line-height: 1;">${c.score.toLocaleString()}</div>
                                <small class="text-muted d-block" style="font-size: 0.7rem;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</small>
                            </div>
                        </div>
                    </div>`;
            }
            
            const next3Div = document.getElementById('next3List');
            next3Div.innerHTML = '';
            for(let i=3; i<6; i++) {
                let c = ranked[i];
                next3Div.innerHTML += `
                    <div class="d-flex align-items-center border-bottom py-2 justify-content-between">
                        <div class="d-flex align-items-center flex-grow-1" style="min-width: 0;">
                            <span class="me-3 text-muted fw-bold small text-center" style="width:30px; flex-shrink: 0;">#${i+1}</span>
                            <img src="${c.imgSidebar}" class="rank-img-small me-3">
                            <div class="text-start lh-1 overflow-hidden">
                                <div class="fw-bold text-dark text-truncate" style="font-size:0.9rem;">‡πÄ‡∏ö‡∏≠‡∏£‡πå ${c.no}</div>
                                <small class="text-muted text-truncate" style="font-size:0.8rem;">${c.name}</small>
                            </div>
                        </div>
                        <span class="fw-bold text-primary fs-5 ps-2" style="flex-shrink: 0;">${c.score.toLocaleString()}</span>
                    </div>`;
            }
        }
    </script>
</body>
</html>

