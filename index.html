<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2569 ‡πÄ‡∏Ç‡∏ï 4 ‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            overflow: hidden; margin: 0; padding: 0;
            display: flex; flex-direction: column; height: 100vh;
        }

        /* --- Header --- */
        .top-header {
            height: 70px; background: #2c3e50; color: white;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 2000; flex-shrink: 0;
        }
        .brand-section { font-weight: bold; font-size: 1.3rem; display: flex; align-items: center; }
        
        /* Filter Capsule */
        .right-controls { display: flex; align-items: center; gap: 15px; }
        .filter-capsule {
            display: flex; align-items: center;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50px; padding: 5px 15px;
            backdrop-filter: blur(5px);
        }

        /* Dropdown Style */
        .custom-select {
            background: transparent; border: none;
            color: white; font-weight: bold; font-size: 0.95rem;
            padding: 5px 10px; cursor: pointer; outline: none;
            appearance: none; 
            text-align: left;
            min-width: 120px;
        }
        .custom-select option { color: #333; }
        .custom-select:disabled { color: rgba(255,255,255,0.4); cursor: not-allowed; }

        .divider { width: 1px; height: 20px; background: rgba(255,255,255,0.3); margin: 0 5px; }

        .btn-toggle-sidebar {
            background: #f1c40f; color: #2c3e50; border: none;
            padding: 8px 20px; border-radius: 50px; font-weight: bold;
            transition: 0.2s; box-shadow: 0 4px 10px rgba(241, 196, 15, 0.3);
        }
        .btn-toggle-sidebar:hover { background: #d4ac0d; transform: translateY(-2px); }

        /* --- Map & Sidebar --- */
        #map { flex-grow: 1; width: 100%; background: #f8f9fa; z-index: 1; }
        
        .map-legend {
            position: absolute; bottom: 30px; left: 30px; z-index: 1000;
            background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); font-size: 0.9em; border-left: 5px solid #2c3e50;
        }
        .color-dot { display: inline-block; width: 15px; height: 15px; border-radius: 3px; margin-right: 8px; vertical-align: middle; }

        /* Popup Styling */
        .custom-popup .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; }
        .custom-popup .leaflet-popup-content { margin: 0; width: 300px !important; }
        .popup-header { background: #2c3e50; color: white; padding: 12px 15px; }
        .popup-body { padding: 15px; background: #fff; }
        .popup-row { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .popup-img { width: 35px; height: 35px; border-radius: 50%; margin-right: 10px; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* Sidebar Styling */
        .offcanvas-end { width: 420px; z-index: 3000; top: 70px !important; height: calc(100vh - 70px); }
        @media (max-width: 768px) { 
            .offcanvas-end { width: 100%; top: 110px !important; height: calc(100vh - 110px); }
            .top-header { flex-direction: column; height: auto; padding: 10px; gap: 10px; align-items: stretch; }
            .right-controls { flex-direction: column; width: 100%; }
            .filter-capsule { width: 100%; justify-content: space-between; }
        }
        
        .rank-big { background: #fff; border-left: 5px solid #f1c40f; }
        .rank-img-big { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; }
        .rank-img-small { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; }
    </style>
</head>
<body>

    <div class="top-header">
        <div class="brand-section">
            <i class="fas fa-chart-pie me-2 text-warning"></i> Dashboard ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2569 ‡πÄ‡∏Ç‡∏ï 4 ‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™
        </div>

        <div class="right-controls">
            <div class="filter-capsule">
                <i class="fas fa-map-marker-alt ms-2 me-2 text-warning"></i>
                <select id="selectAmphoe" class="custom-select" onchange="filterData()">
                    <option value="all">üìç ‡∏ó‡∏∏‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>
                    </select>
                
                <div class="divider"></div>
                
                <select id="selectTambon" class="custom-select" onchange="filterData()" disabled>
                    <option value="all">üö© ‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>
                    </select>
                <i class="fas fa-chevron-down ms-2 me-2 small text-light opacity-50"></i>
            </div>

            <button class="btn-toggle-sidebar" type="button" data-bs-toggle="offcanvas" data-bs-target="#rightSidebar">
                <i class="fas fa-list-ol me-2"></i> ‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            </button>
        </div>
    </div>

    <div id="map"></div>

    <div class="map-legend">
        <div class="fw-bold mb-2">‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</div>
        <div class="mb-1"><span class="color-dot" style="background:#e74c3c;"></span> ‡∏≠.‡∏£‡∏∞‡πÅ‡∏á‡∏∞</div>
        <div class="mb-1"><span class="color-dot" style="background:#f39c12;"></span> ‡∏≠.‡∏à‡∏∞‡πÅ‡∏ô‡∏∞</div>
        <div class="mb-1"><span class="color-dot" style="background:#3498db;"></span> ‡∏≠.‡∏™‡∏∏‡∏Ñ‡∏¥‡∏£‡∏¥‡∏ô</div>
        <div class="mt-2 text-muted small border-top pt-2">
            <i class="fas fa-circle text-success"></i> ‡∏à‡∏∏‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á
        </div>
    </div>

    <div class="offcanvas offcanvas-end show" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1" id="rightSidebar">
        <div class="offcanvas-header bg-light border-bottom">
            <h5 class="offcanvas-title text-dark fw-bold"><i class="fas fa-trophy text-warning me-2"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body bg-light d-flex flex-column">
            <div class="flex-grow-1 overflow-auto">
                <h6 class="fw-bold text-secondary small mb-3">üèÜ 3 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å (‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</h6>
                <div id="top3List"></div>
                <h6 class="fw-bold text-secondary small mb-3 mt-4">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÜ</h6>
                <div id="next3List"></div>
            </div>
            <div class="mt-3 pt-3 border-top">
                <div class="card border-0 shadow-sm rounded-4 bg-white">
                    <div class="card-body text-center">
                        <small class="text-uppercase text-muted fw-bold" style="font-size:0.8em;">
                            <i class="fas fa-users"></i> ‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Real-time)
                        </small>
                        <h2 class="fw-bold text-dark my-1" id="totalTurnout">...</h2>
                        <div class="progress rounded-pill bg-light mt-2" style="height: 8px;">
                            <div class="progress-bar bg-success" id="turnoutBar" style="width: 0%"></div>
                        </div>
                        <small id="turnoutPercent" class="fw-bold text-success">0%</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ============================================
        // ‚ö†Ô∏è ‡πÉ‡∏™‡πà URL APPS SCRIPT ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚ö†Ô∏è
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxjGKqtdINH8KQIH4exj3qyE2zdsNNDj9Mm5x7kWyFI-UgJ9a2zsbFKXpzffOtpm1ea_Q/exec'; 
        
        const candidatesConfig = [
            { no: 1, name: "‡πÄ‡∏ö‡∏≠‡∏£‡πå 1", color: "#0d6efd", img: "https://img2.pic.in.th/1350d68330953409d.png" },
            { no: 2, name: "‡πÄ‡∏ö‡∏≠‡∏£‡πå 2", color: "#198754", img: "https://img5.pic.in.th/file/secure-sv1/2e202bb41458cf2b1.png" },
            { no: 3, name: "‡πÄ‡∏ö‡∏≠‡∏£‡πå 3", color: "#dc3545", img: "https://img2.pic.in.th/315d39fe9e514ce03.png" },
            { no: 4, name: "‡πÄ‡∏ö‡∏≠‡∏£‡πå 4", color: "#fd7e14", img: "https://img5.pic.in.th/file/secure-sv1/48e77349737a85eda.png" },
            { no: 5, name: "‡πÄ‡∏ö‡∏≠‡∏£‡πå 5", color: "#0dcaf0", img: "https://img2.pic.in.th/5b028fab05d845d6a.png" },
            { no: 6, name: "‡πÄ‡∏ö‡∏≠‡∏£‡πå 6", color: "#6f42c1", img: "https://img2.pic.in.th/69adc3cca999bb66d.png" }
        ];
        // ============================================

        const map = L.map('map', { zoomControl: false }).setView([6.05, 101.80], 10);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        let geojsonLayer;
        let markersLayer = L.layerGroup().addTo(map);
        let globalData = null;

        loadBoundaries();
        fetchData();

        async function loadBoundaries() {
            try {
                const geoUrl = 'https://raw.githubusercontent.com/jitlogo/thailand-geojson/master/amphoe.geojson';
                const response = await fetch(geoUrl);
                const geoData = await response.json();

                geojsonLayer = L.geoJSON(geoData, {
                    filter: function(feature) {
                        const props = JSON.stringify(feature.properties).toLowerCase();
                        return (props.includes('ra-ngae') || props.includes('‡∏£‡∏∞‡πÅ‡∏á‡∏∞')) ||
                               (props.includes('chanae') || props.includes('‡∏à‡∏∞‡πÅ‡∏ô‡∏∞')) ||
                               (props.includes('sukhirin') || props.includes('‡∏™‡∏∏‡∏Ñ‡∏¥‡∏£‡∏¥‡∏ô'));
                    },
                    style: function(feature) {
                        const props = JSON.stringify(feature.properties).toLowerCase();
                        let color = '#999';
                        if (props.includes('ra-ngae')) color = '#e74c3c';
                        else if (props.includes('chanae')) color = '#f39c12';
                        else if (props.includes('sukhirin')) color = '#3498db';
                        return { color: 'white', weight: 2, opacity: 1, fillColor: color, fillOpacity: 0.2 };
                    },
                    onEachFeature: function(feature, layer) {
                        layer.bindTooltip(feature.properties.NAME_TH || feature.properties.NAME_2, {
                            permanent: true, direction: 'center', className: 'bg-transparent border-0 fw-bold text-dark shadow-none'
                        });
                        layer.on('click', function(e) { map.fitBounds(e.target.getBounds()); });
                    }
                }).addTo(map);
                if (geojsonLayer.getLayers().length > 0) map.fitBounds(geojsonLayer.getBounds());
            } catch (err) { console.error(err); }
        }

        async function fetchData() {
            try {
                const response = await fetch(scriptURL);
                globalData = await response.json();
                initFilterOptions(globalData.units);
                filterData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
            } catch (error) { console.error("Fetch Error:", error); }
        }

        function initFilterOptions(units) {
            const amphoeSet = new Set();
            // User Sheet: Col F (5) = Amphoe
            units.forEach(u => { if(u[5]) amphoeSet.add(u[5]); });

            const selectAmphoe = document.getElementById('selectAmphoe');
            amphoeSet.forEach(amp => {
                let opt = document.createElement('option');
                opt.value = amp;
                opt.text = `‡∏≠.${amp}`;
                selectAmphoe.appendChild(opt);
            });
        }

        function filterData() {
            if (!globalData) return;

            const selectedAmphoe = document.getElementById('selectAmphoe').value;
            const selectTambon = document.getElementById('selectTambon');
            const selectedTambon = selectTambon.value;

            // Handle Amphoe Change
            if (event && event.target.id === 'selectAmphoe') {
                selectTambon.innerHTML = '<option value="all">üö© ‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>';
                if (selectedAmphoe === 'all') {
                    selectTambon.disabled = true;
                    if (geojsonLayer) map.fitBounds(geojsonLayer.getBounds());
                } else {
                    selectTambon.disabled = false;
                    const tambonSet = new Set();
                    // User Sheet: Col F(5)=Amphoe, Col G(6)=Tambon
                    globalData.units.forEach(u => {
                        if (u[5] === selectedAmphoe && u[6]) tambonSet.add(u[6]);
                    });
                    tambonSet.forEach(tam => {
                        let opt = document.createElement('option');
                        opt.value = tam;
                        opt.text = tam;
                        selectTambon.appendChild(opt);
                    });
                }
            }

            // Filtering
            let filteredUnits = globalData.units.filter(u => {
                let matchAmphoe = (selectedAmphoe === 'all') || (u[5] === selectedAmphoe);
                let matchTambon = (selectedTambon === 'all') || (u[6] === selectedTambon);
                return matchAmphoe && matchTambon;
            });

            // Calculate & Render
            calculateAndRender(filteredUnits, globalData.scores);

            // Zoom Logic
            if (selectedAmphoe === 'all') {
                if (geojsonLayer && geojsonLayer.getLayers().length > 0) {
                     map.fitBounds(geojsonLayer.getBounds());
                }
            } else if (selectedTambon === 'all') {
                if (geojsonLayer) {
                    geojsonLayer.eachLayer(function(layer) {
                        const props = JSON.stringify(layer.feature.properties).toLowerCase();
                        let mapName = "";
                        if(selectedAmphoe.includes("‡∏£‡∏∞‡πÅ‡∏á‡∏∞")) mapName = "ra-ngae";
                        else if(selectedAmphoe.includes("‡∏à‡∏∞‡πÅ‡∏ô‡∏∞")) mapName = "chanae";
                        else if(selectedAmphoe.includes("‡∏™‡∏∏‡∏Ñ‡∏¥‡∏£‡∏¥‡∏ô")) mapName = "sukhirin";
                        
                        if(mapName && props.includes(mapName)) {
                            map.fitBounds(layer.getBounds());
                        }
                    });
                }
            } else {
                if (filteredUnits.length > 0) {
                    let latlngs = [];
                    filteredUnits.forEach(u => {
                        let lat = parseFloat(u[2]);
                        let lng = parseFloat(u[3]);
                        if(!isNaN(lat) && !isNaN(lng)) latlngs.push([lat, lng]);
                    });
                    if (latlngs.length > 0) {
                        let bounds = L.latLngBounds(latlngs);
                        map.fitBounds(bounds, { padding: [50, 50], maxZoom: 14 });
                    }
                }
            }
        }

        function calculateAndRender(units, scores) {
            markersLayer.clearLayers();

            let globalScores = [0,0,0,0,0,0];
            let totalEligible = 0;
            let totalVoted = 0;

            units.forEach(unit => {
                const unitName = unit[0];
                const lat = parseFloat(unit[2]);
                const lng = parseFloat(unit[3]);
                const unitVoters = parseInt(unit[4]) || 0;
                const amphoe = unit[5] || '-';
                const tambon = unit[6] || '-';

                totalEligible += unitVoters;

                const unitScoresLog = scores.filter(row => row[1] === unitName);
                let currentScores = [0,0,0,0,0,0];
                let votedCount = 0;

                if (unitScoresLog.length > 0) {
                    const latest = unitScoresLog[unitScoresLog.length - 1];
                    // Score Sheet: 0=Time, 1=Unit, 2=Amphoe, 3=Tambon, 4=TimeRound
                    // Score starts at index 5 (Score1)
                    for(let i=0; i<6; i++) {
                        let sc = parseInt(latest[5+i]) || 0; 
                        currentScores[i] = sc;
                        globalScores[i] += sc;
                        votedCount += sc;
                    }
                    totalVoted += votedCount;
                }

                if (!isNaN(lat) && !isNaN(lng)) {
                    createMarker(lat, lng, unitName, amphoe, tambon, currentScores, unitVoters, votedCount);
                }
            });

            updateSidebar(globalScores, totalEligible, totalVoted);
        }

        function createMarker(lat, lng, name, amphoe, tambon, scores, eligible, voted) {
            let ranked = scores.map((score, index) => ({ score, ...candidatesConfig[index] })).sort((a, b) => b.score - a.score);
            let percent = eligible > 0 ? (voted/eligible*100).toFixed(1) : 0;

            let popupContent = `
                <div class="popup-header">
                    <span class="badge bg-light text-dark mb-1">‡∏≠.${amphoe} / ‡∏ï.${tambon}</span>
                    <div class="popup-unit-name">${name}</div>
                </div>
                <div class="popup-body">
                    <div class="d-flex justify-content-between bg-light p-2 rounded mb-2">
                         <span>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: <b>${voted.toLocaleString()}</b></span>
                         <span class="text-success fw-bold">${percent}%</span>
                    </div>`;
            
            for(let i=0; i<3; i++) {
                let c = ranked[i];
                popupContent += `
                    <div class="popup-row">
                        <div style="width:20px; color:#ccc;">#${i+1}</div>
                        <img src="${c.img}" class="popup-img">
                        <div class="flex-grow-1"><small>‡πÄ‡∏ö‡∏≠‡∏£‡πå ${c.no}</small> <br> <b>${c.name}</b></div>
                        <div class="fw-bold text-success">${c.score.toLocaleString()}</div>
                    </div>`;
            }
            popupContent += `</div>`;

            L.circleMarker([lat, lng], {
                radius: 5, fillColor: "#28a745", color: "#ffffff", weight: 1.5, opacity: 1, fillOpacity: 1
            }).addTo(markersLayer).bindPopup(popupContent, { className: 'custom-popup' });
        }

        function updateSidebar(globalScores, totalEligible, totalVoted) {
            document.getElementById('totalTurnout').innerText = `${totalVoted.toLocaleString()} / ${totalEligible.toLocaleString()}`;
            let percent = totalEligible > 0 ? (totalVoted/totalEligible*100) : 0;
            document.getElementById('turnoutBar').style.width = `${percent}%`;
            document.getElementById('turnoutPercent').innerText = `${percent.toFixed(2)}%`;

            let ranked = globalScores.map((score, index) => ({ score, ...candidatesConfig[index] })).sort((a, b) => b.score - a.score);

            const top3Div = document.getElementById('top3List');
            top3Div.innerHTML = '';
            for(let i=0; i<3; i++) {
                let c = ranked[i];
                top3Div.innerHTML += `
                    <div class="card mb-2 border-0 shadow-sm rank-big">
                        <div class="card-body p-2 d-flex align-items-center">
                            <div class="me-3 text-center" style="width:30px;"><h5 class="m-0 fw-bold text-warning">#${i+1}</h5></div>
                            <img src="${c.img}" class="rank-img-big me-3">
                            <div class="flex-grow-1"><h6 class="m-0 fw-bold text-dark">‡πÄ‡∏ö‡∏≠‡∏£‡πå ${c.no}</h6><small class="text-muted">${c.name}</small></div>
                            <div class="fw-bold fs-5 text-dark">${c.score.toLocaleString()}</div>
                        </div>
                    </div>`;
            }
            
            const next3Div = document.getElementById('next3List');
            next3Div.innerHTML = '';
            for(let i=3; i<6; i++) {
                let c = ranked[i];
                next3Div.innerHTML += `
                    <div class="d-flex align-items-center border-bottom py-2">
                        <span class="me-3 text-muted fw-bold small text-center" style="width:30px;">#${i+1}</span>
                        <img src="${c.img}" class="rank-img-small me-3">
                        <div class="flex-grow-1 small"><span class="fw-bold text-dark">‡πÄ‡∏ö‡∏≠‡∏£‡πå ${c.no}</span></div>
                        <span class="fw-bold text-dark">${c.score.toLocaleString()}</span>
                    </div>`;
            }
        }
    </script>
</body>
</html>
